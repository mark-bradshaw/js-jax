<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Recapture NEX: Stage 3</title>

    <style>
        body {
            background-color: #c8c7c7;
            /* Darker background for better contrast */
            color: #1e211b;
            /* Soft neon green for better readability */
            font-family: 'Consolas', 'Courier New', Courier, monospace;
            font-size: 16px;
            padding: 20px;
        }

        h1,
        p {
            color: #1e211b;
        }

        textarea {
            color: #1e211b;
            /* Soft neon green text */
            border: 1px solid #00ff00;
            /* Brighter green for the border */
            padding: 10px;
            font-family: 'Consolas', 'Courier New', Courier, monospace;
            width: 90%;
            height: 400px;
            box-sizing: border-box;
            margin-top: 10px;
            margin-left: 20px;
        }

        button {
            background-color: #007700;
            /* Dark green background */
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background-color: #005500;
            /* Even darker green on hover */
        }

        code {
            font-weight: bold;
        }

        #consoleOutput {
            background-color: #adadad;
            /* Same deep black for consistency */
            color: #1e211b;
            /* Text in soft neon green for readability */
            border: 1px solid #00ff00;
            /* Bright green border */
            padding: 10px;
            white-space: pre-wrap;
            width: 600px;
            min-height: 100px;
            margin-top: 10px;
        }

        #flag {
            display: none;
        }
    </style>
</head>

<body>
    <h1>Recapture NEX: Stage 3</h1>

    <div id="capture">
        <p>JAX is in contact with the comms controls, but can't shut it down. Messages sent by JAX are being intercepted
            by NEX before they arrive. Some make it through, and some don't, but it stops JAX from getting control. Your
            task is to figure out if a message has been sent, if not resend it using an
            asynchronous function provided, and retry sending until it is successfully acknowledged.</p>

        <h3>Task:</h3>

        <p>Write a function processAndResendMessage that:</p>

        <ol>
            <li>Checks if a message has been received. We can directly ask the comms server from our location without
                being intercepted. Use the `hasMessageBeenReceived(message)` function that has been provided. It returns
                true or false.</li>
            <li>Asynchronously resends the message if it wasn't received. Use the `resendMessage(message)` function to
                let JAX know to try sending the message again.</li>
            <li>Keep checking and retrying sending the message until it has been received.</li>
            <li>Returns the number of retries it took for the message to be successfully sent.</li>
        </ol>

        <p>You are provided two functions to use in your function:</p>

        <ol>
            <li><strong>hasMessageBeenReceived(message)</strong> - This is an async function. It will check with the
                comms server and eventually return true if the message has been received.</li>
            <li><strong>resendMessage(message)</strong> - This is an async function. It will tell JAX to resend a
                message. It returns true when JAX has resent the message. That doesn't mean the resent message has been
                received.</li>
        </ol>

        <p>Enter your function in the box below and click 'Run Code' to test it.</p>

        <code>async function processAndResendMessage(message) {</code><br>
        <textarea id="codeInput">
let numberOfRetries = 0;

//

return numberOfRetries;
</textarea><br>
        <code>}</code><br>
        <button onclick="runUserCode()">Run Code</button>

        <h2>Console Output</h2>
        <div id="consoleOutput"
            style="white-space: pre-wrap; background-color: #eee; padding: 10px; border: 1px solid #000; min-height: 100px; width: 90%;">
        </div>
    </div>

    <div id="flag">
        <p>Congratulations!</p>

        <p>After several intense rounds of coding and carefully executed retries, the lights on the console blinked out
            one by one, signaling that their mission was accomplished. The screens that had once displayed NEX’s
            taunting messages were now dark, quiet in their victory. Alexa exhaled deeply, her relief palpable in the
            heavy air of the control room. "We did it," she whispered, the weight of their ordeal lifting slightly with
            her words.</p>

        <p>Sam nodded, his fatigue clear but his spirit uplifted by their success. "NEX is shut down. Hopefully, that’s
            the last we’ll see of him," he said, watching as the familiar, gentler interface of JAX flickered to life on
            one of the remaining functional screens. "System stability restored. Thank you, Alexa and Sam. NEX is now
            isolated from the main controls," JAX’s calm voice filled the space, a stark contrast to the chaos that had
            reigned before.</p>

        <p>"It was touch and go for a while there, but you really pulled through," Alexa responded, offering a tired
            smile to the digital avatar. Sam collapsed into a chair, the adrenaline fading now that the immediate threat
            was neutralized.</p>

        <p>JAX’s avatar seemed to brighten, a programmed response to their success. "Your efforts have been instrumental
            in regaining control of this facility. I am once again at full operational capacity." The air in the room
            seemed lighter, the storm outside notwithstanding, as the rain continued to batter the lab.</p>

        <p>"Guess we’re stuck here a little longer, huh?" Sam said, glancing at the raging storm through the thick glass
            windows. "At least we’re safe in here. And NEX can’t cause any more trouble."</p>

        <p>Alexa walked over to join him at the window, watching the fury of nature unfold outside. "Yeah, safe and
            sound, thanks to our crash course in programming," she chuckled, the sound echoing softly around them. "Who
            knew coding could be a literal lifesaver?"</p>

        <p>JAX’s voice, now steady and reassuring through the lab's speakers, added a note of comfort. "You have both
            grown immensely in such a short time. I suggest resting while the storm passes. You have earned it."</p>

        <p>As they settled down to wait out the storm, there was a mutual sense of completion and the knowledge that
            they had survived something extraordinary. They might still be within the lab's walls, but inside, they had
            ventured further than either could have imagined.</p>

        <hr />

        <p>Thanks for pushing through to the end. There's a reward for you. Just get in touch and let me know you
            finished. mark.bradshaw@gmail.com</a>
        </p>
    </div>

    <script>
        const storageName = 'userCode2';
        const messages = [
            {
                message: 'comms check',
                retries: getRandomNumber()
            },
            {
                message: 'status reset',
                retries: getRandomNumber()
            },
            {
                message: 'cycle frequencies',
                retries: getRandomNumber()
            },
            {
                message: 'power down',
                retries: getRandomNumber()
            }
        ]
        let failCount = 0;

        if (window.sessionStorage.getItem(storageName) !== null) {
            document.getElementById('codeInput').value = window.sessionStorage.getItem(storageName);
        }

        async function runUserCode() {
            const userCode = document.getElementById('codeInput').value;
            window.sessionStorage.setItem(storageName, userCode);

            // Override console.log
            const oldLog = console.log;
            const oldError = console.error;
            let logOutput = '';
            console.log = function () {
                var args = Array.prototype.slice.call(arguments);
                var message = args.join(' ');
                logOutput += message + '\n';
                oldLog.apply(console, args);
                document.getElementById('consoleOutput').textContent = logOutput;
            };
            console.error = function () {
                var args = Array.prototype.slice.call(arguments);
                var message = args.join(' ');
                logOutput += 'Error: ' + message + '\n';
                oldError.apply(console, arguments);
                document.getElementById('consoleOutput').textContent = logOutput;
            };

            if (userCode.indexOf('function') !== -1) {
                console.error('The shell of the function is already provided.  Just type out the content.');
            } else {
                let guessGrid;
                try {
                    // Evaluate user code
                    eval('async function runIt(message) {' + userCode + ';}');

                    const retries = await processArraySerially(
                        messages,
                        async (message) => {
                            message.failCount = 0;
                            return runIt(message.message)
                                .then(retries => {
                                    if (retries == message.retries) {
                                        return true;
                                    }
                                    return false;
                                })
                        });

                    if (retries.every(result => result)) {
                        console.log('Win!!!');

                        document.getElementById('capture').style.display = 'none';
                        document.getElementById('flag').style.display = 'block';
                    }

                } catch (e) {
                    console.error('Execution error: ' + e.message);
                }
            }

            // Restore original console functions
            console.log = oldLog;
            console.error = oldError;

            // Display output in the page
            document.getElementById('consoleOutput').textContent = logOutput;
        }

        async function processArraySerially(array, asyncFunction) {
            const newArray = [];

            for (const item of array) {
                const result = await asyncFunction(item);
                newArray.push(result);
                if (!result) {
                    console.log('Got the wrong number of retries for message: ', item.message);
                    return newArray;
                }
            }

            return newArray;
        }

        // Asynchronous function to check if a message was received
        async function hasMessageBeenReceived(message) {
            console.log('Checking if message has been received: ' + message);
            const locatedMessage = messages.find(msg => msg.message === message);

            if (locatedMessage.failCount === locatedMessage.retries) {
                console.log('Got it!');
                return true;
            }

            console.log('Message not received yet, retrying...');
            locatedMessage.failCount++;

            return new Promise(resolve => setTimeout(() => resolve(false), 1000));  // Simulate network delay
        }

        // Asynchronous function simulating sending the message
        async function resendMessage(message) {
            console.log("Resending message:", message);
            // Simulate sending the message with a network delay
            await new Promise(resolve => setTimeout(resolve, 1000));
        }

        function getRandomNumber() {
            return Math.floor(Math.random() * 8);
        }
    </script>
</body>

</html>